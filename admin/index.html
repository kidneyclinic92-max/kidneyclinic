<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel | Clinic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../assets/css/styles.css" />
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <h1>Admin Login</h1>
      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required />
        </div>
        <button type="submit" class="btn primary">Login</button>
      </form>
    </div>
  </div>

  <div id="admin-panel" class="admin-panel" style="display: none;">
    <header class="admin-header">
      <div class="container">
        <h1>Admin Panel</h1>
        <nav class="admin-nav">
          <a href="#dashboard" class="nav-link active">Dashboard</a>
          <a href="#appointments" class="nav-link">Appointments</a>
          <a href="#doctors" class="nav-link">Doctors</a>
          <a href="#services" class="nav-link">Services</a>
          <a href="#homepage" class="nav-link">Homepage</a>
          <a href="#achievements" class="nav-link">Medical Tourism</a>
          <a href="#reviews" class="nav-link">Reviews</a>
          <a href="#podcasts" class="nav-link">Podcast</a>
          <a href="#kidney" class="nav-link">Kidney Transplant Dept</a>
          <button id="logout-btn" class="btn">Logout</button>
        </nav>
      </div>
    </header>

    <main class="admin-main">
      <div class="container">
        <div id="status-bar" style="margin-bottom: 16px; display: none;
          padding: 10px; border-radius: 6px; background: #fff3cd; color: #664d03; border: 1px solid #ffecb5;
        "></div>
        <!-- Dashboard -->
        <section id="dashboard" class="admin-section active" style="text-align: center;">
          <h2>Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>Doctors</h3>
              <span id="doctors-count">-</span>
            </div>
            <div class="stat-card">
              <h3>Services</h3>
              <span id="services-count">-</span>
            </div>
            <div class="stat-card">
              <h3>Reviews</h3>
              <span id="reviews-count">-</span>
            </div>
          </div>
          <div class="quick-actions" style="text-align: center;">
            <h3>Quick Actions</h3>
            <div class="action-buttons" style="justify-content: center;">
              <button class="btn primary" onclick="showSection('doctors')">Manage Doctors</button>
              <button class="btn primary" onclick="showSection('services')">Manage Services</button>
              <button class="btn primary" onclick="showSection('homepage')">Edit Homepage</button>
            </div>
          </div>
        </section>

        <!-- Appointments Management -->
        <section id="appointments" class="admin-section">
          <h2>Manage Appointments</h2>
          <div class="section-controls">
            <select id="appointment-status-filter" style="padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text);margin-right:10px">
              <option value="">All Appointments</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="cancelled">Cancelled</option>
              <option value="completed">Completed</option>
            </select>
            <button class="btn primary" onclick="admin.filterAppointments()">Filter</button>
          </div>
          <div id="appointments-list" class="content-list"></div>
        </section>

        <!-- Doctors Management -->
        <section id="doctors" class="admin-section">
          <h2>Manage Doctors</h2>
          <div class="section-controls">
            <button class="btn primary" onclick="addDoctor()">Add Doctor</button>
          </div>
          <div id="doctors-list" class="content-list"></div>
        </section>

        <!-- Services Management -->
        <section id="services" class="admin-section">
          <h2>Manage Services</h2>
          <div class="section-controls">
            <button class="btn primary" onclick="addService()">Add Service</button>
          </div>
          <div id="services-list" class="content-list"></div>
        </section>

        <!-- Homepage Management -->
        <section id="homepage" class="admin-section">
          <h2>Edit Homepage</h2>
          <div id="homepage-editor"></div>
        </section>

        <!-- Medical Tourism Management -->
        <section id="achievements" class="admin-section">
          <h2>Manage Medical Tourism</h2>
          <div class="section-controls">
            <button class="btn primary" onclick="addAchievement()">Add Medical Tourism Item</button>
          </div>
          <div id="achievements-list" class="content-list"></div>
        </section>

        <!-- Kidney Department Management -->
        <section id="kidney" class="admin-section">
          <h2 style="text-align: center;">Manage Kidney Transplant Department</h2>
          <div id="kidney-editor"></div>
        </section>

        <!-- Reviews Management -->
        <section id="reviews" class="admin-section">
          <h2>Manage Reviews</h2>
          <div class="section-controls">
            <button class="btn primary" onclick="addReview()">Add Review</button>
          </div>
          <div id="reviews-list" class="content-list"></div>
        </section>

        <!-- Podcast Management -->
        <section id="podcasts" class="admin-section">
          <h2 style="text-align:center;">Podcast Library</h2>
          <div id="podcasts-editor"></div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal for editing content -->
  <div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Edit Item</h3>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="edit-form"></form>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" onclick="saveItem()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Inline config fallback - ensures API URL is always available
    if (typeof window.__CONFIG__ === 'undefined') {
      window.__CONFIG__ = {};
    }
    if (!window.__CONFIG__.API_BASE_URL) {
      window.__CONFIG__.API_BASE_URL = 'https://kidney-clinic-e2f6c7fnf0cxg5dy.eastus-01.azurewebsites.net';
    }
    console.log('Config initialized:', window.__CONFIG__.API_BASE_URL);
  </script>
  <script src="../config.js" onerror="console.error('Failed to load config.js - using inline fallback')"></script>
  <script>
    // Capture all errors before admin.js loads
    const errors = [];
    window.addEventListener('error', function(e) {
      const stack = e && e.error && e.error.stack ? e.error.stack : null;
      errors.push({
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: stack
      });
      console.error('JavaScript error:', e.message, 'at', e.filename + ':' + e.lineno);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
      errors.push({
        type: 'Unhandled Promise Rejection',
        reason: e.reason
      });
      console.error('Unhandled promise rejection:', e.reason);
    });
  </script>
  <script>
    // Try multiple paths to find admin.js
    const adminJsPaths = [
      'admin.js',
      './admin.js',
      'admin/admin.js',
      '../admin/admin.js'
    ];
    
    let adminJsLoaded = false;
    
    function tryLoadAdminJs(pathIndex) {
      if (pathIndex >= adminJsPaths.length) {
        console.error('Failed to load admin.js from all attempted paths');
        document.body.innerHTML += '<div style="padding:20px;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;border-radius:4px;margin:20px;position:fixed;top:20px;left:20px;right:20px;z-index:10000;">' +
          '<h2>Error: admin.js Failed to Load</h2>' +
          '<p>The admin.js file could not be loaded from any of these paths:</p>' +
          '<ul>' + adminJsPaths.map(p => '<li>' + p + '</li>').join('') + '</ul>' +
          '<p><strong>Possible issues:</strong></p>' +
          '<ul>' +
          '<li>File not deployed to Render</li>' +
          '<li>File path is incorrect</li>' +
          '<li>Case sensitivity issue (Admin.js vs admin.js)</li>' +
          '<li>Check Render deployment logs</li>' +
          '</ul>' +
          '<p>Current URL: ' + window.location.href + '</p>' +
          '</div>';
        return;
      }
      
      const script = document.createElement('script');
      script.src = adminJsPaths[pathIndex];
      script.onload = () => {
        console.log('✓ admin.js loaded successfully from: ' + adminJsPaths[pathIndex]);
        adminJsLoaded = true;
        setTimeout(() => {
          if (typeof AdminPanel === 'undefined') {
            console.error('AdminPanel still not defined after admin.js loaded');
          } else {
            console.log('✓ AdminPanel class is defined!');
          }
        }, 100);
      };
      script.onerror = () => {
        console.warn('Failed to load from: ' + adminJsPaths[pathIndex]);
        tryLoadAdminJs(pathIndex + 1);
      };
      document.body.appendChild(script);
    }
    
    tryLoadAdminJs(0);
  </script>
  <script>
    // Verify AdminPanel loads after a delay
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (typeof AdminPanel === 'undefined') {
          console.error('AdminPanel class not found after admin.js loaded');
          let errorMsg = '<div style="padding:20px;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;border-radius:4px;margin:20px;">' +
            '<h2>Error: Admin Panel Failed to Load</h2>' +
            '<p>AdminPanel class not found. This usually means there\'s a JavaScript error in admin.js.</p>' +
            '<p><strong>Please check:</strong></p>' +
            '<ul>' +
            '<li>Open browser console (F12) and look for JavaScript errors</li>' +
            '<li>Check Network tab to verify admin.js loaded (should be 200 OK)</li>' +
            '<li>Visit <a href="diagnose.html" style="color:#721c24;text-decoration:underline;">diagnose.html</a> for detailed diagnostics</li>' +
            '<li>Visit <a href="test-admin.js.html" style="color:#721c24;text-decoration:underline;">test-admin.js.html</a> to test admin.js loading</li>' +
            '</ul>';
          
          if (errors.length > 0) {
            errorMsg += '<p><strong>JavaScript Errors Found:</strong></p><pre style="background:#fff;padding:10px;border-radius:4px;overflow:auto;max-height:200px;">' + 
              JSON.stringify(errors, null, 2) + '</pre>';
          }
          
          errorMsg += '</div>';
          
          // Only show error if login screen exists (to avoid duplicate errors)
          const existingError = document.querySelector('[style*="background:#f8d7da"]');
          if (!existingError) {
            document.body.insertAdjacentHTML('afterbegin', errorMsg);
          }
        } else {
          console.log('✓ AdminPanel class loaded successfully');
        }
      }, 2000); // Increased timeout to 2 seconds
    });
  </script>
</body>
</html>
